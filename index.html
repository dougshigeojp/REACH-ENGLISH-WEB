<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REACH English| Digital Lesson</title>
    
    <!-- Fonts: Montserrat for headers, Poppins for body -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    
    <!-- Link to external Stylesheet (Block 2) -->
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <!-- STICKY METADATA HEADER -->
    <header id="metadata-header">
        <div class="header-content">
            <span id="display-grade">GRADE</span> ‚Ä¢ 
            <span id="display-bimester">BIMESTER</span> ‚Ä¢ 
            <span id="display-chapter">CHAPTER</span>
        </div>
    </header>

    <!-- RETRACTABLE MENU -->
    <button id="menu-toggle" aria-label="Toggle Menu">
        <div class="bar"></div>
        <div class="bar"></div>
        <div class="bar"></div>
    </button>

    <nav id="slide-menu">
          <!-- NEW: Compact Side-by-Side Buttons -->
    <div class="compact-nav-row">
        <a href="index.html?lesson=home" class="home-link">üè† HOME</a>
        <a href="exercises.html?id=ex-home" class="home-link">üèãÔ∏è PRACTICE</a>
    </div>
        <div class="menu-header">
            <div class="menu-logo"><span class="orange-text">REACH</span>English</div>
            <div id="menu-grade-label">GRADE LEVEL</div>
            <div id="menu-chapter-label">Chapter Title</div>
        </div>
        <ul id="nav-list">
            <!-- Dynamic menu items will be injected here by engine.js -->
        </ul>
    </nav>

    <!-- MAIN CONTENT AREA -->
    <main id="main-container">
        <!-- Lessons pages will be injected here -->
        <div id="lesson-content">
            <!-- 1. LOADING STATE WITH SAFETY BUTTON -->
            <div class="loader-container" style="text-align: center; padding-top: 50px;">
                <div class="loader">Loading Lesson...</div>
                <br>
                <!-- This button is visible while loading. If it hangs, user can click this. -->
                <a href="index.html?lesson=home" style="display:inline-block; margin-top:20px; text-decoration:none; color:#666; font-size:0.9rem; border:1px solid #ccc; padding:8px 15px; border-radius:20px;">
                    ‚úñ Cancel / Return Home
                </a>
            </div>
        </div>
    </main>

<!-- BACK TO TOP BUTTON (Bottom Center) -->
    <button id="back-to-top-btn" title="Back to Top">
        <span>‚¨ÜÔ∏è</span>
    </button>

    <!-- STICKY UI CLUSTER (Bottom-Right: Glossary & Navigation) -->
    <div id="ui-cluster">
        <button id="glossary-btn" title="Open Glossary">
            <span class="glossary-icon">üìñ</span>
        </button>
        <div class="nav-buttons">
            <button id="prev-btn" class="nav-arrow" disabled aria-label="Previous Page">‚Üê</button>
            <button id="next-btn" class="nav-arrow" aria-label="Next Page">‚Üí</button>
        </div>
    </div>
    
   <!-- GLOSSARY MODAL -->
    <div id="glossary-modal" class="modal-overlay">
        <div class="modal-content">
            <!-- Header now contains Title, Topic, and Close Button -->
            <div class="modal-header">
                <h3 style="margin:0; font-size:1rem;">üìñ</h3>
                <div id="glossary-topic-label">TOPIC NAME</div>
                <button id="close-glossary">&times;</button>
            </div>
            
            <!-- Pagination Numbers -->
            <div id="glossary-pagination"></div>

            <!-- Scrollable Content -->
            <div id="glossary-list">
                <!-- Terms will be injected here -->
            </div>
        </div>
    </div>

    <!-- AUDIO ENGINE (Hidden) -->
    <audio id="global-audio-player"></audio>

    
    
    <div id="tooltip-container" class="tooltip-box"></div>

    
    <!-- CORE SCRIPTS -->
    <!-- Block 3: The Mechanical Logic -->
    <script src="engine.js"></script>
    
    <!-- Block 4: The Content Data (With Updated Error Buttons) -->
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const lessonId = urlParams.get('lesson');
        const contentDiv = document.getElementById('lesson-content');

        // Helper to generate the error button HTML
        const getBackHomeBtn = () => `
            <div style="margin-top:20px;">
                <a href="index.html?lesson=home" style="background:#333; color:white; text-decoration:none; padding:10px 20px; border-radius:5px; font-weight:bold;">
                    üè† RETURN TO DASHBOARD
                </a>
            </div>`;

        if (!lessonId) {
            contentDiv.innerHTML = `
                <div style="padding: 20px; text-align: center; color: #d63384; font-weight: bold;">
                    ‚ö†Ô∏è SETUP REQUIRED<br><br>
                    You are missing the lesson ID in the URL.
                    ${getBackHomeBtn()}
                </div>`;
        } else {
            console.log("Attempting to load: data/" + lessonId + ".js");
            
            const dataScript = document.createElement('script');
            dataScript.src = `data/${lessonId}.js`;
            
            dataScript.onload = () => {
                console.log("File loaded. Initializing...");
                if (typeof window.initLesson !== 'function') {
                     contentDiv.innerHTML = `<div style="text-align:center; padding:20px; color:red;">
                        <h3>Error: Engine not ready.</h3>
                        ${getBackHomeBtn()}
                     </div>`;
                }
            };

            // 2. FILE NOT FOUND ERROR
            dataScript.onerror = () => {
                contentDiv.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: red;">
                        <h3>‚ùå ERROR: File Not Found</h3>
                        <p>Could not find: <b>data/${lessonId}.js</b></p>
                        <hr>
                        <p>Check the filename and URL.</p>
                        ${getBackHomeBtn()}
                    </div>`;
            };

            document.head.appendChild(dataScript);
        }

        // 3. SYNTAX ERROR (TYPO IN JS FILE)
        window.onerror = function(message, source, lineno, colno, error) {
            if(message.includes("is not defined") || message.includes("SyntaxError")) {
                contentDiv.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: red;">
                        <h3>‚ùå JAVASCRIPT ERROR</h3>
                        <p>There is a typo in your <b>${lessonId}.js</b> file.</p>
                        <p style="background:#eee; padding:10px; border-radius:5px;">${message}</p>
                        <p>Line: <b>${lineno}</b></p>
                        ${getBackHomeBtn()}
                    </div>`;
            }
        };
    </script>

</body>
</html>